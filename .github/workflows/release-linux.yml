name: Release (Linux x86_64)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-tarball:
    name: Build Linux tarball (Debian 12 baseline)
    runs-on: ubuntu-24.04
    container: debian:12
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils python3 \
            build-essential pkg-config clang libclang-dev \
            autoconf automake libtool \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            librsvg2-dev \
            libayatana-appindicator3-dev \
            libasound2-dev \
            libsentencepiece-dev \
            libprotobuf-dev \
            patchelf

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn via Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.19 --activate
          yarn --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install JS dependencies
        working-directory: app
        run: yarn install --frozen-lockfile

      - name: Build release tarball
        run: |
          chmod +x scripts/package-linux.sh
          scripts/package-linux.sh dist

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-dist
          path: dist/
          if-no-files-found: error

  installer-smoke:
    name: Installer smoke (${{ matrix.distro }})
    runs-on: ubuntu-24.04
    needs: build-tarball
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-24.04
            image: ubuntu:24.04
          - distro: debian-12
            image: debian:12
          - distro: fedora-40
            image: fedora:40
          - distro: arch
            image: archlinux:base
    container: ${{ matrix.image }}
    steps:
      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Install prerequisites
        run: |
          set -eux
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y --no-install-recommends sudo curl ca-certificates python3 xz-utils passwd
          elif command -v dnf >/dev/null 2>&1; then
            dnf -y install sudo curl ca-certificates python3 which tar gzip xz shadow-utils
          elif command -v pacman >/dev/null 2>&1; then
            pacman -Sy --noconfirm archlinux-keyring || true
            pacman-key --init || true
            pacman-key --populate archlinux || true
            pacman -Sy --noconfirm --needed sudo curl ca-certificates python which tar gzip xz shadow
          else
            echo "Unsupported base image (no known package manager)" >&2
            exit 1
          fi

      - name: Create test user with passwordless sudo
        run: |
          set -eux
          if ! id -u tester >/dev/null 2>&1; then
            useradd -m -s /bin/bash tester
          fi
          mkdir -p /etc/sudoers.d
          echo "tester ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/tester
          chmod 0440 /etc/sudoers.d/tester

      - name: Run installer against local artifact
        run: |
          set -eux
          ASSETS_DIR="$(pwd)/dist"
          BASE_URL="file://${ASSETS_DIR}"
          sudo -u tester -H env OPENFLOW_BASE_URL="${BASE_URL}" bash "${ASSETS_DIR}/install.sh" --yes --no-models

      - name: Verify installed binary links
        run: |
          set -eux
          test -x /opt/openflow/openflow-bin
          out="$(LD_LIBRARY_PATH=/opt/openflow/lib ldd /opt/openflow/openflow-bin 2>&1 || true)"
          echo "$out"
          if echo "$out" | grep -q "not found"; then
            echo "Missing runtime libraries" >&2
            exit 1
          fi

  ui-e2e-ubuntu:
    name: UI E2E (Ubuntu 24.04)
    runs-on: ubuntu-24.04
    needs: build-tarball
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            webkit2gtk-driver \
            xvfb

          # ALSA runtime (Ubuntu 24.04+ uses the t64 transition).
          if apt-cache show libasound2t64 >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends libasound2t64
          else
            sudo apt-get install -y --no-install-recommends libasound2
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn via Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.19 --activate
          yarn --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tauri-driver
        run: cargo install tauri-driver --locked

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Extract tarball
        run: |
          set -eux
          rm -rf /tmp/openflow-e2e
          mkdir -p /tmp/openflow-e2e
          tar -xzf dist/openflow-linux-x86_64.tar.gz -C /tmp/openflow-e2e

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: yarn install --frozen-lockfile

      - name: Run E2E (headless)
        working-directory: e2e-tests
        env:
          OPENFLOW_E2E_APP_PATH: /tmp/openflow-e2e/openflow/openflow-bin
          LD_LIBRARY_PATH: /tmp/openflow-e2e/openflow/lib
        run: |
          set -eux
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR &
          XVFB_PID=$!
          trap 'kill $XVFB_PID' EXIT
          export DISPLAY=:99
          yarn test

  ui-e2e-debian:
    name: UI E2E (Debian 12)
    runs-on: ubuntu-24.04
    needs: build-tarball
    container: debian:12
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl xz-utils python3 \
            build-essential pkg-config clang libclang-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            libasound2 \
            webkit2gtk-driver \
            xvfb

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn via Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.19 --activate
          yarn --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tauri-driver
        run: cargo install tauri-driver --locked

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Extract tarball
        run: |
          set -eux
          rm -rf /tmp/openflow-e2e
          mkdir -p /tmp/openflow-e2e
          tar -xzf dist/openflow-linux-x86_64.tar.gz -C /tmp/openflow-e2e

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: yarn install --frozen-lockfile

      - name: Run E2E (headless)
        working-directory: e2e-tests
        env:
          OPENFLOW_E2E_APP_PATH: /tmp/openflow-e2e/openflow/openflow-bin
          LD_LIBRARY_PATH: /tmp/openflow-e2e/openflow/lib
        run: |
          set -eux
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR &
          XVFB_PID=$!
          trap 'kill $XVFB_PID' EXIT
          export DISPLAY=:99
          yarn test

  ui-e2e-fedora:
    name: UI E2E (Fedora 40)
    runs-on: ubuntu-24.04
    needs: build-tarball
    container: fedora:40
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          set -eux
          dnf -y install \
            ca-certificates curl which tar gzip xz \
            webkit2gtk4.1 webkit2gtk4.1-devel \
            gtk3 \
            alsa-lib \
            libevdev \
            libayatana-appindicator-gtk3 \
            xorg-x11-server-Xvfb

          # Ensure WebKitWebDriver is discoverable (some distros don't put it on PATH).
          if ! command -v WebKitWebDriver >/dev/null 2>&1; then
            for p in \
              /usr/bin/WebKitWebDriver \
              /usr/libexec/webkit2gtk-4.1/WebKitWebDriver \
              /usr/libexec/webkitgtk-6.0/WebKitWebDriver \
              /usr/lib/webkit2gtk-4.1/WebKitWebDriver \
              /usr/lib/webkitgtk-6.0/WebKitWebDriver
            do
              if [ -x "$p" ]; then
                ln -sf "$p" /usr/local/bin/WebKitWebDriver
                break
              fi
            done
          fi
          command -v WebKitWebDriver

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn via Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.19 --activate
          yarn --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tauri-driver
        run: cargo install tauri-driver --locked

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Extract tarball
        run: |
          set -eux
          rm -rf /tmp/openflow-e2e
          mkdir -p /tmp/openflow-e2e
          tar -xzf dist/openflow-linux-x86_64.tar.gz -C /tmp/openflow-e2e

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: yarn install --frozen-lockfile

      - name: Run E2E (headless)
        working-directory: e2e-tests
        env:
          OPENFLOW_E2E_APP_PATH: /tmp/openflow-e2e/openflow/openflow-bin
          LD_LIBRARY_PATH: /tmp/openflow-e2e/openflow/lib
        run: |
          set -eux
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR &
          XVFB_PID=$!
          trap 'kill $XVFB_PID' EXIT
          export DISPLAY=:99
          yarn test

  ui-e2e-arch:
    name: UI E2E (Arch)
    runs-on: ubuntu-24.04
    needs: build-tarball
    container: archlinux:base
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          set -eux
          pacman -Sy --noconfirm archlinux-keyring || true
          pacman-key --init || true
          pacman-key --populate archlinux || true
          pacman -Sy --noconfirm --needed \
            ca-certificates curl which tar gzip xz \
            gtk3 \
            alsa-lib \
            libevdev \
            webkit2gtk-4.1 \
            libayatana-appindicator \
            xorg-server-xvfb

          # Ensure WebKitWebDriver exists (some Arch builds package it separately).
          if ! command -v WebKitWebDriver >/dev/null 2>&1; then
            pacman -Sy --noconfirm --needed webkitgtk-6.0 || true
            pacman -Sy --noconfirm --needed webkitgtk || true
          fi
          command -v WebKitWebDriver

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Yarn via Corepack
        run: |
          corepack enable
          corepack prepare yarn@1.22.19 --activate
          yarn --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tauri-driver
        run: cargo install tauri-driver --locked

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Extract tarball
        run: |
          set -eux
          rm -rf /tmp/openflow-e2e
          mkdir -p /tmp/openflow-e2e
          tar -xzf dist/openflow-linux-x86_64.tar.gz -C /tmp/openflow-e2e

      - name: Install E2E dependencies
        working-directory: e2e-tests
        run: yarn install --frozen-lockfile

      - name: Run E2E (headless)
        working-directory: e2e-tests
        env:
          OPENFLOW_E2E_APP_PATH: /tmp/openflow-e2e/openflow/openflow-bin
          LD_LIBRARY_PATH: /tmp/openflow-e2e/openflow/lib
        run: |
          set -eux
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR &
          XVFB_PID=$!
          trap 'kill $XVFB_PID' EXIT
          export DISPLAY=:99
          yarn test

  upload-release-assets:
    name: Upload GitHub Release assets
    runs-on: ubuntu-24.04
    needs:
      - installer-smoke
      - ui-e2e-ubuntu
      - ui-e2e-debian
      - ui-e2e-fedora
      - ui-e2e-arch
    steps:
      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-dist
          path: dist

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/openflow-linux-x86_64.tar.gz
            dist/openflow-linux-x86_64.tar.gz.sha256
            dist/latest.json
            dist/install.sh
          generate_release_notes: true
